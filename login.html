<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <style>
        /* PWA Standalone Mode Fixes */
        @media all and (display-mode: standalone) {
            html, body {
                height: 100vh !important;
                max-height: 100vh !important;
                overflow: hidden !important;
                margin: 0 !important;
                padding: 0 !important;
                position: fixed !important;
                top: 0 !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
            }
            
            .screen {
                padding-top: env(safe-area-inset-top) !important;
                padding-bottom: calc(60px + env(safe-area-inset-bottom)) !important;
                height: 100vh !important;
                box-sizing: border-box !important;
            }
            
            .nav-bar {
                bottom: env(safe-area-inset-bottom) !important;
                padding-bottom: env(safe-area-inset-bottom) !important;
            }
            
            .background {
                height: 100vh !important;
                width: 100vw !important;
            }
        }
        
        /* iPhone XS Max PWA specific */
        @media screen and (device-width: 414px) and (device-height: 896px) and (display-mode: standalone) {
            .screen {
                padding-top: 44px !important; /* Status bar height */
                padding-bottom: 94px !important; /* Nav + home indicator */
            }
            
            .nav-bar {
                bottom: 34px !important; /* Home indicator space */
                height: 60px !important;
            }
        }
        
        /* Fallback for non-PWA iPhone XS Max */
        @media screen and (device-width: 414px) and (device-height: 896px) and (display-mode: browser) {
            html, body {
                height: 100vh !important;
                max-height: 100vh !important;
                overflow: hidden !important;
                margin: 0 !important;
                padding: 0 !important;
                position: fixed !important;
                top: 0 !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
            }
            .nav-bar {
                bottom: 0px !important;
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }
        }
    </style>
    <title>eTax Mobile - ƒêƒÉng nh·∫≠p</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="eTax Mobile">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="eTax Mobile">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/logo.webp">
    <link rel="icon" type="image/webp" sizes="32x32" href="assets/logo.webp">
    <link rel="icon" type="image/webp" sizes="16x16" href="assets/logo.webp">
    <link rel="mask-icon" href="assets/logo.webp" color="#000000">

    <!-- iOS Optimizations CSS -->
    <link rel="stylesheet" href="css/ios-optimizations.css">

    <!-- Clone layout styles -->
    <link rel="stylesheet" href="css/login-clone.css">

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body>

    <main class="screen">
        <section class="brand">
            <div class="logo-circle">
                <img src="assets/logo.webp" alt="Logo Thu·∫ø Nh√† N∆∞·ªõc">
            </div>
            <h1>eTax Mobile</h1>
        </section>

        <form id="loginForm" class="login-form">
            <div class="error-message" id="errorMsg"></div>

            <div class="field">
                <label for="taxId" class="field-label">M√£ s·ªë thu·∫ø</label>
                <div class="field-input">
                    <img src="assets/icon-mst-new.svg" alt="M√£ s·ªë thu·∫ø">
                    <input type="text" id="taxId" class="form-input" autocomplete="username">
                </div>
            </div>

            <div class="field">
                <label for="password" class="field-label">M·∫≠t kh·∫©u</label>
                <div class="field-input">
                    <img src="assets/icon-password-new.svg" alt="M·∫≠t kh·∫©u">
                    <input type="password" id="password" class="form-input" autocomplete="current-password">
                    <img src="assets/icon-eye.svg" alt="·∫®n/hi·ªán m·∫≠t kh·∫©u" class="toggle" id="togglePassword">
                </div>
            </div>

            <div class="helper-links">
                <a href="#" onclick="return false;">Qu√™n t√†i kho·∫£n (m√£ s·ªë thu·∫ø)?</a>
                <a href="#" onclick="return false;">Qu√™n m·∫≠t kh·∫©u ?</a>
            </div>

            <div class="action-row">
                <button type="submit" class="btn-primary" id="loginBtn">ƒêƒÉng nh·∫≠p</button>
                <img src="assets/faceid1.png" alt="FaceID" class="faceid">
            </div>
        </form>

        <section class="vneid">
            <button class="vneid-button" id="vneidBtn">
                <span class="vneid-text">ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n<br>ƒê·ªãnh danh ƒëi·ªán t·ª≠</span>
                <img src="assets/vnid.png" alt="VNeID">
            </button>
        </section>

            <section class="register">
                <p>B·∫°n ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" class="highlight" onclick="return false;">ƒêƒÉng k√Ω ngay</a></p>
                <p class="foreign">Ng∆∞·ªùi n∆∞·ªõc ngo√†i ho·∫∑c ng∆∞·ªùi Vi·ªát Nam s·ªëng ·ªü n∆∞·ªõc ngo√†i kh√¥ng c√≥ s·ªë ƒë·ªãnh danh c√° nh√¢n ch∆∞a c√≥ m√£ s·ªë thu·∫ø? <a href="#" class="highlight" onclick="return false;">ƒêƒÉng k√Ω thu·∫ø ngay.</a></p>
            </section>
    </main>

    <footer class="nav-bar">
        <a href="#" class="nav-item" onclick="openQR()">
            <img src="assets/icon-qr.png" alt="QR tem">
            <span>QR tem</span>
        </a>
        <a href="#" class="nav-item" onclick="return false;">
            <img src="assets/tienich.png" alt="Ti·ªán √≠ch">
            <span>Ti·ªán √≠ch</span>
        </a>
        <a href="#" class="nav-item" onclick="return false;">
            <img src="assets/hotro.png" alt="H·ªó tr·ª£">
            <span>H·ªó tr·ª£</span>
        </a>
        <a href="#" class="nav-item" onclick="shareApp()">
            <img src="assets/chiase.png" alt="Chia s·∫ª">
            <span>Chia s·∫ª</span>
        </a>
    </footer>

    <div class="background">
        <img src="assets/bglogin.png" alt="Background">
    </div>

    <script src="src/admin-essential/mock-data-generator.js"></script>
    <script>
        document.getElementById('togglePassword').addEventListener('click', function () {
            const passwordInput = document.getElementById('password');
            const toggleIcon = this;

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.src = 'assets/icon-eye-closed.svg';
            } else {
                passwordInput.type = 'password';
                toggleIcon.src = 'assets/icon-eye.svg';
            }
        });

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const taxId = document.getElementById('taxId').value.trim();
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');
            const loginBtn = document.getElementById('loginBtn');

            function showError(msg) {
                errorMsg.textContent = msg;
                errorMsg.style.display = 'block';
            }

            errorMsg.style.display = 'none';

            if (!taxId || !password) {
                showError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }

            try {
                loginBtn.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';
                loginBtn.disabled = true;

                // Validate v·ªõi d·ªØ li·ªáu t·ª´ admin
                console.log('üîç Debug Login - MST:', taxId, 'Password:', password);

                // L·∫•y d·ªØ li·ªáu t·ª´ localStorage
                const userDataKey = `etax_user_data_${taxId}`;
                let userData = JSON.parse(localStorage.getItem(userDataKey) || 'null');

                // Debug: Ki·ªÉm tra t·∫•t c·∫£ keys trong localStorage
                console.log('üîç All localStorage keys:', Object.keys(localStorage));
                console.log('üîç Looking for key:', userDataKey);
                console.log('üîç Found userData:', userData);

                if (!userData) {
                    console.log('‚ùå Login failed - MST not found in localStorage');
                    console.log('üîÑ Trying to reload from Firestore...');
                    
                    // Th·ª≠ load t·ª´ Firestore n·∫øu localStorage kh√¥ng c√≥
                    if (db) {
                        try {
                            const doc = await db.collection('users').doc(taxId).get();
                            if (doc.exists) {
                                userData = doc.data();
                                localStorage.setItem(userDataKey, JSON.stringify(userData));
                                console.log('‚úÖ Loaded user data from Firestore:', userData);
                            } else {
                                console.log('‚ùå User not found in Firestore either');
                                showError('M√£ s·ªë thu·∫ø kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng');
                                return;
                            }
                        } catch (error) {
                            console.error('‚ùå Error loading from Firestore:', error);
                            showError('M√£ s·ªë thu·∫ø kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng');
                            return;
                        }
                    } else {
                        showError('M√£ s·ªë thu·∫ø kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng');
                        return;
                    }
                }

                console.log('üîç Comparing passwords - Input:', password, 'Stored:', userData.password);
                if (userData.password !== password) {
                    console.log('‚ùå Login failed - wrong password');
                    showError('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng');
                    return;
                }

                console.log('‚úÖ Login successful, creating session...');
                // T·∫°o user session v·ªõi d·ªØ li·ªáu t·ª´ admin
                createUserSession(taxId, userData);

                console.log('üîÑ Redirecting to main page...');
                // ƒêi·ªÅu h∆∞·ªõng sang trang ch√≠nh
                setTimeout(() => {
                    window.location.href = 'src/pages/index.html';
                }, 500);
            } catch (err) {
                showError('C√≥ l·ªói khi ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i.');
                console.error(err);
            } finally {
                loginBtn.textContent = 'ƒêƒÉng nh·∫≠p';
                loginBtn.disabled = false;
            }
        });

        // VNeID button click
        document.getElementById('vneidBtn').addEventListener('click', function () {
            // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o g√¨, ch·ªâ lag m·ªôt ch√∫t
            setTimeout(() => {
                // Kh√¥ng l√†m g√¨ c·∫£
            }, 100);
        });

        // Bottom navigation functions
        function openQR() {
            // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o g√¨, ch·ªâ lag m·ªôt ch√∫t
            setTimeout(() => {
                // Kh√¥ng l√†m g√¨ c·∫£
            }, 100);
        }

        function shareApp() {
            // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o g√¨, ch·ªâ lag m·ªôt ch√∫t
            setTimeout(() => {
                // Kh√¥ng l√†m g√¨ c·∫£
            }, 100);
        }

        // FaceID icon click
        document.querySelector('.faceid-icon').addEventListener('click', function () {
            // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o g√¨, ch·ªâ lag m·ªôt ch√∫t
            setTimeout(() => {
                // Kh√¥ng l√†m g√¨ c·∫£
            }, 100);
        });

        // Function t·∫°o user session v·ªõi d·ªØ li·ªáu t·ª´ admin
        function createUserSession(mst, userData) {
            console.log('üîß Creating user session for MST:', mst);
            console.log('üîß User data:', userData);
            
            // L∆∞u MST ƒëang ƒëƒÉng nh·∫≠p
            localStorage.setItem('etax_logged_in_user', mst);
            
            // L∆∞u th√¥ng tin user ƒë·ªÉ c√°c trang kh√°c s·ª≠ d·ª•ng
            localStorage.setItem('etax_user_info', JSON.stringify({
                mst: userData.mst,
                fullName: userData.representative || userData.companyName || 'Ng∆∞·ªùi d√πng',
                companyName: userData.companyName,
                address: userData.address,
                taxOffice: userData.taxOffice || 'C·ª•c Thu·∫ø TP.HCM',
                phone: userData.phone,
                email: userData.email
            }));
            
            // L∆∞u to√†n b·ªô d·ªØ li·ªáu user (bao g·ªìm taxInfo)
            localStorage.setItem('etax_user_data', JSON.stringify(userData));
            
            console.log('‚úÖ User session created for MST:', mst);
        }

        // BroadcastChannel ƒë·ªÉ nh·∫≠n d·ªØ li·ªáu t·ª´ admin
        let broadcastChannel;
        
        function initBroadcastChannel() {
            if ('BroadcastChannel' in window) {
                broadcastChannel = new BroadcastChannel('etax_sync');
                
                broadcastChannel.onmessage = function(event) {
                    const { type, data } = event.data;
                    
                    if (type === 'user_created') {
                        // C·∫≠p nh·∫≠t localStorage t·ª´ admin tab
                        localStorage.setItem(`etax_user_data_${data.mst}`, JSON.stringify(data.userData));
                        console.log(`üîÑ Received user data from admin for MST: ${data.mst}`);
                        
                        // Hi·ªÉn th·ªã th√¥ng b√°o cho user
                        showSuccess(`‚úÖ ƒê√£ nh·∫≠n d·ªØ li·ªáu MST ${data.mst} t·ª´ admin. B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p ngay!`);
                    }
                };
            }
        }

        function showSuccess(message) {
            // T·∫°o th√¥ng b√°o th√†nh c√¥ng
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Kh·ªüi t·∫°o BroadcastChannel khi trang load
        initBroadcastChannel();
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
            authDomain: "etax-7fbf8.firebaseapp.com",
            databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "etax-7fbf8",
            storageBucket: "etax-7fbf8.appspot.com",
            messagingSenderId: "1030026724634",
            appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
            measurementId: "G-YS5DLECJE6"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.log('Firebase already initialized');
        }

        const db = firebase.firestore ? firebase.firestore() : null;
        
        // Load d·ªØ li·ªáu t·ª´ Firestore khi trang load
        function loadDataFromFirestore() {
            if (!db) {
                console.log('‚ö†Ô∏è Firestore not available, using localStorage only');
                return;
            }
            
            console.log('üîÑ Loading data from Firestore...');
            
            db.collection('users').get()
                .then((querySnapshot) => {
                    let loadedCount = 0;
                    querySnapshot.forEach((doc) => {
                        const mst = doc.id;
                        const userData = doc.data();
                        
                        // L∆∞u v√†o localStorage
                        localStorage.setItem(`etax_user_data_${mst}`, JSON.stringify(userData));
                        loadedCount++;
                        
                        console.log(`üì• Loaded user data for MST: ${mst}`);
                    });
                    
                    if (loadedCount > 0) {
                        console.log(`‚úÖ Loaded ${loadedCount} users from Firestore`);
                    } else {
                        console.log('‚ÑπÔ∏è No users found in Firestore');
                    }
                })
                .catch((error) => {
                    console.error('‚ùå Error loading from Firestore:', error);
                });
        }
        
        // Load d·ªØ li·ªáu t·ª´ Firestore khi trang load
        loadDataFromFirestore();
    </script>
</body>

</html>
