let trustedDeviceManager;let isRedirectFromTokenLogin = false;document.addEventListener('DOMContentLoaded',function () {console.log('=== FIXED LOGIN PAGE - NO INFINITE LOOP ===');initializeLoginPage()});async function initializeLoginPage() {try {checkRedirectFlags();trustedDeviceManager = new TrustedDeviceManager(db);if (!isRedirectFromTokenLogin) {console.log('ğŸ” Normal access - checking authentication...');await checkAuthenticationSafely()} else {console.log('âœ… Redirect from token-login - SKIP auth check');showMessage('âœ… Thiáº¿t bá»‹ Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c thá»±c! Vui lÃ²ng Ä‘Äƒng nháº­p.','success')} setupLoginForm()} catch (error) {console.error('âŒ Login page initialization failed:',error);showMessage('Lá»—i khá»Ÿi táº¡o trang Ä‘Äƒng nháº­p','error')} } function checkRedirectFlags() {const redirectFlag = localStorage.getItem('etax_redirect_from_token_login');const deviceVerificationComplete = localStorage.getItem('etax_device_verification_complete');const skipDeviceCheck = localStorage.getItem('etax_skip_device_check');const windowFlag = window.skipDeviceCheckOnLogin;console.log('ğŸ” Checking redirect flags:',{redirectFlag,deviceVerificationComplete,skipDeviceCheck,windowFlag });if (redirectFlag === 'true' || deviceVerificationComplete === 'true' || skipDeviceCheck === 'true' || windowFlag === true) {isRedirectFromTokenLogin = true;console.log('ğŸ”„ DETECTED:Redirect from token-login â†’ Skip device check');localStorage.removeItem('etax_redirect_from_token_login');localStorage.removeItem('etax_device_verification_complete');localStorage.removeItem('etax_skip_device_check');window.skipDeviceCheckOnLogin = false} } async function checkAuthenticationSafely() {try {const userLoggedIn = localStorage.getItem('etax_logged_in_user');const loginSuccess = localStorage.getItem('etax_login_success');console.log('ğŸ” Authentication status:',{userLoggedIn:!!userLoggedIn,loginSuccess:!!loginSuccess });if (userLoggedIn && loginSuccess) {console.log('âœ… User already logged in â†’ redirect to index');showMessage('ÄÃ£ Ä‘Äƒng nháº­p,Ä‘ang chuyá»ƒn hÆ°á»›ng...','info');setTimeout(() => {window.location.href = 'index.html'},1000);return} console.log('ğŸ” Checking device trust...');const deviceCheck = await trustedDeviceManager.isDeviceTrusted();if (!deviceCheck.trusted) {console.log('âš ï¸ Device not trusted - but NOT auto-redirecting');showMessage('âš ï¸ Thiáº¿t bá»‹ chÆ°a Ä‘Æ°á»£c xÃ¡c thá»±c. Vui lÃ²ng xÃ¡c thá»±c thiáº¿t bá»‹ trÆ°á»›c khi Ä‘Äƒng nháº­p.','warning');showDeviceAuthPrompt();return} console.log('âœ… Device is trusted â†’ ready for login');showMessage('Thiáº¿t bá»‹ Ä‘Ã£ Ä‘Æ°á»£c tin cáº­y. Vui lÃ²ng Ä‘Äƒng nháº­p.','info')} catch (error) {console.error('âŒ Authentication check failed:',error);showMessage('Lá»—i kiá»ƒm tra xÃ¡c thá»±c:' + error.message,'error')} } function showDeviceAuthPrompt() {const promptHtml = ` <div id="deviceAuthPrompt" style=" background:rgba(255,152,0,0.1);border:1px solid #ff9800;border-radius:8px;padding:16px;margin:16px 0;text-align:center;"> <p style="margin-bottom:12px;color:#ff9800;"> âš ï¸ Thiáº¿t bá»‹ chÆ°a Ä‘Æ°á»£c xÃ¡c thá»±c </p> <button onclick="redirectToTokenLogin()" style=" background:#ff9800;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:8px;">XÃ¡c thá»±c thiáº¿t bá»‹</button> <button onclick="dismissPrompt()" style=" background:transparent;color:#ff9800;border:1px solid #ff9800;padding:8px 16px;border-radius:4px;cursor:pointer;">Bá» qua</button> </div> `;const container = document.querySelector('.container') || document.body;container.insertAdjacentHTML('afterbegin',promptHtml)} function redirectToTokenLogin() {console.log('ğŸ”„ User manually requesting device auth');window.location.href = 'token-login.html'} function dismissPrompt() {const prompt = document.getElementById('deviceAuthPrompt');if (prompt) {prompt.remove()} showMessage('Báº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p vá»›i tÃ i khoáº£n cÃ³ sáºµn hoáº·c xÃ¡c thá»±c thiáº¿t bá»‹ sau.','info')} function setupLoginForm() {console.log('ğŸ¨ Setting up login form...');const taxIdInput = document.getElementById("tax-id");if (taxIdInput) {setTimeout(() => taxIdInput.focus(),100)} const passwordInput = document.getElementById("password");if (passwordInput) {passwordInput.addEventListener('keypress',function (e) {if (e.key === 'Enter') {e.preventDefault();login()} })} if (taxIdInput) {taxIdInput.addEventListener('keypress',function (e) {if (e.key === 'Enter') {e.preventDefault();if (passwordInput) passwordInput.focus()} })} const forms = document.querySelectorAll('form');forms.forEach(form => {form.addEventListener('submit',function (e) {e.preventDefault();login()})});console.log('âœ… Login form setup complete')} async function login() {const taxId = document.getElementById("tax-id")?.value?.trim();const password = document.getElementById("password")?.value?.trim();if (!taxId || !password) {showMessage('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin','error');return} const loginBtn = document.querySelector('.btn-login');if (loginBtn) {loginBtn.classList.add('loading');loginBtn.textContent = 'Äang Ä‘Äƒng nháº­p...'} try {console.log('ğŸ” Attempting login for:',taxId);const userRef = db.ref('taxpayers/' + taxId);const snapshot = await userRef.once('value');if (!snapshot.exists()) {throw new Error('MÃ£ sá»‘ thuáº¿ khÃ´ng tá»“n táº¡i')} const userData = snapshot.val();if (userData.password !== password) {throw new Error('Máº­t kháº©u khÃ´ng chÃ­nh xÃ¡c')} console.log('âœ… Login successful');localStorage.setItem('etax_logged_in_user',taxId);localStorage.setItem('etax_login_success','true');localStorage.setItem('etax_user_data',JSON.stringify(userData));await userRef.update({lastLogin:Date.now(),lastLoginIP:await getClientIP() });showMessage('ÄÄƒng nháº­p thÃ nh cÃ´ng!','success');setTimeout(() => {window.location.href = 'index.html'},1000)} catch (error) {console.error('âŒ Login failed:',error);showMessage('Lá»—i Ä‘Äƒng nháº­p:' + error.message,'error')} finally {if (loginBtn) {loginBtn.classList.remove('loading');loginBtn.textContent = 'ÄÄƒng nháº­p'} } } async function getClientIP() {try {const response = await fetch('https:const data = await response.json();return data.ip} catch (error) {return 'unknown'} } function showMessage(text,type = 'info') {const oldMessage = document.querySelector('.message');if (oldMessage) oldMessage.remove();const message = document.createElement('div');message.className = `message ${type}-msg`;message.textContent = text;message.style.display = 'block';const container = document.querySelector('.container') || document.body;container.insertBefore(message,container.firstChild);setTimeout(() => {if (message.parentNode) {message.remove()} },5000)} function showError(message) {showMessage(message,'error')} function showSuccess(message) {showMessage(message,'success')} function showInfo(message) {showMessage(message,'info')} function showWarning(message) {showMessage(message,'warning')} console.log('âœ… Fixed login.js loaded - No infinite loop!');