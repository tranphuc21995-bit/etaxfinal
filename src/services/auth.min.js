import {auth,db } from "/shared/js/firebase-init.js";import {signInWithEmailAndPassword } from "https:import {doc,getDoc } from "https:const $ = (s)=>document.querySelector(s);window.onload = () => {const urlParams = new URLSearchParams(window.location.search);const mstParam = urlParams.get('mst');if (mstParam) {$("#mst").value = mstParam;$("#pass").focus()} };$("#btnLogin").onclick = async ()=>{const loginValue = $("#mst").value.trim();const pass = $("#pass").value;if(!loginValue || !pass){alert("Nhập MST/Email và mật khẩu");return} try{let email = '';let mst = '';if(loginValue.includes('@')) {email = loginValue} else {mst = loginValue;const userDoc = await getDoc(doc(db,"users",mst));if (!userDoc.exists()) {alert(`❌ MST ${mst} chưa được đăng ký trong hệ thống!\n\nVui lòng liên hệ admin để tạo tài khoản.`);return} const userData = userDoc.data();email = userData.login_email || userData.email;if (!email) {alert(`❌ MST ${mst} chưa có email đăng ký!\n\nVui lòng liên hệ admin để cập nhật email.`);return} if (!userData.can_login) {alert(`❌ Tài khoản MST ${mst} chưa được kích hoạt đăng nhập!\n\nVui lòng liên hệ admin.`);return} } const userCredential = await signInWithEmailAndPassword(auth,email,pass);if (!mst) {mst = loginValue.replace('@','').replace(/\./g,'')} localStorage.setItem("mst",mst);localStorage.setItem("email",email);localStorage.setItem("loginTime",new Date().toISOString());alert(`✅ Đăng nhập thành công!\nMST:${mst}\nEmail:${email}`);location.href = "/user/index.html"} catch(e) {console.error("Login error:",e);let errorMsg = "Đăng nhập thất bại:";if (e.code === 'auth/user-not-found') {errorMsg += "Tài khoản không tồn tại. Vui lòng liên hệ admin để tạo tài khoản."} else if (e.code === 'auth/wrong-password') {errorMsg += "Mật khẩu không đúng."} else if (e.code === 'auth/invalid-email') {errorMsg += "Email không hợp lệ."} else {errorMsg += e.message} alert(`❌ ${errorMsg}\n\n💡 Gợi ý:\n- Kiểm tra lại MST/Email và mật khẩu\n- Liên hệ admin nếu chưa có tài khoản`)} };