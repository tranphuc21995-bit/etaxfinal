<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üèóÔ∏è Admin Qu·∫£n l√Ω MST - eTax Mobile</title>
    
    <!-- Auth Guard Script -->
    <script>
        // Ki·ªÉm tra admin ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
        if (localStorage.getItem('admin_logged_in') !== 'true') {
            window.location.href = 'admin-login.html';
        }
    </script>
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    
    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #F8FAFC;
            min-height: 100vh;
            color: #334155;
            padding: 0;
        }

        .admin-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .admin-header {
            background: linear-gradient(135deg, #4A90E2, #5BA3F5);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(74, 144, 226, 0.2);
        }

        .admin-header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-header .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-header .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .tab-navigation {
            background: white;
            border-bottom: 1px solid #E2E8F0;
            padding: 0 30px;
            display: flex;
            gap: 0;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 16px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #64748B;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            color: #4A90E2;
            background: #F8FAFC;
        }

        .tab-button.active {
            color: #4A90E2;
            border-bottom-color: #4A90E2;
            background: #F8FAFC;
        }

        .tab-content {
            display: none;
            padding: 30px;
            flex: 1;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Tab Styles */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #E2E8F0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #4A90E2;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #64748B;
            font-weight: 500;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .action-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #4A90E2;
        }

        .action-card i {
            font-size: 32px;
            color: #4A90E2;
            margin-bottom: 12px;
        }

        .action-card h4 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #334155;
            font-weight: 600;
        }

        .action-card p {
            font-size: 13px;
            color: #64748B;
            line-height: 1.4;
        }

        /* Form Tab Styles */
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #E2E8F0;
        }

        .form-section h2 {
            color: #334155;
            margin-bottom: 24px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-row {
            display: flex;
            flex-direction: column;
        }

        .form-row label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #334155;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row input, .form-row textarea {
            padding: 12px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #F8FAFC;
        }

        .form-row input:focus, .form-row textarea:focus {
            outline: none;
            border-color: #4A90E2;
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            background: linear-gradient(135deg, #4A90E2, #5BA3F5);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .btn-secondary {
            background: #64748B;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .btn-success:hover {
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        /* User List Tab Styles */
        .user-list {
            display: grid;
            gap: 20px;
        }

        .user-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #4A90E2;
        }

        .user-header {
            font-weight: 600;
            color: #334155;
            margin-bottom: 16px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .info-item {
            background: #F8FAFC;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
        }

        .info-label {
            font-weight: 500;
            color: #64748B;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .info-value {
            color: #334155;
            font-size: 14px;
        }

        .tax-summary {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #F59E0B;
        }

        .tax-summary strong {
            color: #92400E;
        }

        .status {
            padding: 16px;
            margin: 16px 0;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status.success {
            background: #F0FDF4;
            color: #16A34A;
            border: 1px solid #BBF7D0;
        }

        .status.error {
            background: #FEF2F2;
            color: #DC2626;
            border: 1px solid #FECACA;
        }

        .status.info {
            background: #EFF6FF;
            color: #2563EB;
            border: 1px solid #BFDBFE;
        }

        @media (max-width: 768px) {
            .admin-header {
                padding: 16px 20px;
            }

            .admin-header h1 {
                font-size: 20px;
            }

            .tab-navigation {
                padding: 0 20px;
                overflow-x: auto;
            }

            .tab-button {
                padding: 12px 16px;
                font-size: 13px;
                white-space: nowrap;
            }

            .tab-content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                grid-template-columns: 1fr;
            }

            .stats-section {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .quick-actions {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }
        }

        /* ===== TAX MODAL STYLES ===== */
        .tax-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .tax-modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .tax-modal-header {
            background: linear-gradient(135deg, #4A90E2, #5BA3F5);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        .tax-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .tax-modal-tabs {
            display: flex;
            border-bottom: 2px solid #E2E8F0;
            background: #F8FAFC;
        }

        .tax-modal-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            color: #64748B;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tax-modal-tab.active {
            border-bottom-color: #4A90E2;
            color: #4A90E2;
            background: white;
        }

        .tax-modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tax-tab-content {
            display: none;
        }

        .tax-tab-content.active {
            display: block;
        }

        .tax-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .tax-form-row {
            display: flex;
            flex-direction: column;
        }

        .tax-form-row label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #334155;
            font-size: 14px;
        }

        .tax-form-row input,
        .tax-form-row textarea {
            padding: 12px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #F8FAFC;
            font-family: inherit;
        }

        .tax-form-row input:focus,
        .tax-form-row textarea:focus {
            outline: none;
            border-color: #4A90E2;
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .tax-form-row textarea {
            resize: vertical;
            min-height: 60px;
        }

        .tax-modal-footer {
            padding: 20px;
            border-top: 1px solid #E2E8F0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Tax Item Card Styles */
        .tax-item-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .tax-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #4A90E2;
        }

        .tax-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .tax-item-title {
            font-weight: 600;
            color: #334155;
            font-size: 16px;
        }

        .tax-item-actions {
            display: flex;
            gap: 8px;
        }

        .tax-item-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tax-item-btn.edit {
            background: #4A90E2;
            color: white;
        }

        .tax-item-btn.delete {
            background: #EF4444;
            color: white;
        }

        .tax-item-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tax-item-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            font-size: 14px;
        }

        .tax-item-field {
            background: #F8FAFC;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
        }

        .tax-item-label {
            font-weight: 500;
            color: #64748B;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .tax-item-value {
            color: #334155;
            font-weight: 500;
        }

        .tax-item-amount {
            color: #DC2626;
            font-weight: 600;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .tax-modal {
                padding: 10px;
            }

            .tax-modal-content {
                max-height: 95vh;
                border-radius: 12px;
            }

            .tax-modal-header {
                padding: 16px;
                border-radius: 12px 12px 0 0;
            }

            .tax-modal-tab {
                padding: 10px 8px;
                font-size: 13px;
            }

            .tax-modal-body {
                padding: 16px;
            }

            .tax-form-grid {
                grid-template-columns: 1fr;
            }

            .tax-modal-footer {
                padding: 16px;
                flex-direction: column;
            }

            .tax-item-info {
                grid-template-columns: 1fr;
            }
        }

        /* Certificate Management */
        .certificate-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .certificate-form {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .certificate-form-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .certificate-form-row label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .certificate-form-row select,
        .certificate-form-row input[type="file"] {
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .certificate-form-row select:focus,
        .certificate-form-row input[type="file"]:focus {
            outline: none;
            border-color: #4A90E2;
        }

        .file-upload-area {
            border: 2px dashed #D1D5DB;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #F9FAFB;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #4A90E2;
            background: #F0F9FF;
        }

        .file-upload-area.dragover {
            border-color: #4A90E2;
            background: #EFF6FF;
        }

        .upload-icon {
            font-size: 32px;
            color: #9CA3AF;
            margin-bottom: 8px;
        }

        .upload-text {
            color: #6B7280;
            font-size: 14px;
        }

        .certificate-preview {
            background: #F8FAFC;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid #E2E8F0;
        }

        .certificate-preview h4 {
            color: #1E293B;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .certificate-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .certificate-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .certificate-info-item label {
            font-size: 12px;
            color: #64748B;
            font-weight: 500;
        }

        .certificate-info-item input {
            padding: 8px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
        }

        .certificate-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn-save-certificate {
            background: #10B981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-save-certificate:hover {
            background: #059669;
        }

        .btn-cancel-certificate {
            background: #6B7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-cancel-certificate:hover {
            background: #4B5563;
        }

        .certificate-list {
            margin-top: 20px;
        }

        .certificate-item {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .certificate-item-info {
            flex: 1;
        }

        .certificate-item-title {
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .certificate-item-details {
            font-size: 14px;
            color: #6B7280;
        }

        .certificate-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-delete-certificate {
            background: #EF4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-delete-certificate:hover {
            background: #DC2626;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-user-cog"></i> Admin Qu·∫£n l√Ω MST</h1>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>

        <div class="tab-navigation">
            <button class="tab-button active" onclick="showTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="tab-button" onclick="showTab('addUser')">
                <i class="fas fa-user-plus"></i> Th√™m MST
            </button>
            <button class="tab-button" onclick="showTab('userList')">
                <i class="fas fa-list"></i> Danh s√°ch MST
            </button>
            <button class="tab-button" onclick="showTab('certificateManager')">
                <i class="fas fa-file-pdf"></i> Qu·∫£n l√Ω ch·ª©ng t·ª´ PDF
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">T·ªïng s·ªë MST</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTaxAmount">0 VND</div>
                    <div class="stat-label">T·ªïng ti·ªÅn thu·∫ø</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingAmount">0 VND</div>
                    <div class="stat-label">C√≤n ph·∫£i n·ªôp</div>
                </div>
            </div>

            <div class="quick-actions">
                <div class="action-card" onclick="showTab('addUser')">
                    <i class="fas fa-user-plus"></i>
                    <h4>Th√™m MST m·ªõi</h4>
                    <p>T·∫°o m√£ s·ªë thu·∫ø v√† th√¥ng tin ng∆∞·ªùi d√πng</p>
                </div>
                <div class="action-card" onclick="refreshStats()">
                    <i class="fas fa-sync-alt"></i>
                    <h4>L√†m m·ªõi d·ªØ li·ªáu</h4>
                    <p>C·∫≠p nh·∫≠t th·ªëng k√™ v√† danh s√°ch</p>
                </div>
                <div class="action-card" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    <h4>Xu·∫•t d·ªØ li·ªáu</h4>
                    <p>T·∫£i xu·ªëng file d·ªØ li·ªáu MST</p>
                </div>
                <div class="action-card" onclick="clearAllData()">
                    <i class="fas fa-trash-alt"></i>
                    <h4>X√≥a t·∫•t c·∫£</h4>
                    <p>Reset to√†n b·ªô d·ªØ li·ªáu h·ªá th·ªëng</p>
                </div>
            </div>
        </div>

        <!-- Add User Tab -->
        <div id="addUser" class="tab-content">
            <div class="form-section">
                <h2><i class="fas fa-plus-circle"></i> Th√™m ng∆∞·ªùi d√πng MST m·ªõi</h2>
                <form id="addUserForm">
                    <div class="form-grid">
                        <div class="form-row">
                            <label for="mst"><i class="fas fa-id-card"></i> M√£ s·ªë thu·∫ø <span style="color: #EF4444;">*</span></label>
                            <input type="text" id="mst" placeholder="Nh·∫≠p m√£ s·ªë thu·∫ø (10-13 s·ªë)" required>
                        </div>

                        <div class="form-row">
                            <label for="password"><i class="fas fa-lock"></i> M·∫≠t kh·∫©u <span style="color: #EF4444;">*</span></label>
                            <input type="password" id="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u cho MST n√†y" required>
                        </div>

                        <div class="form-row">
                            <label for="confirmPassword"><i class="fas fa-lock"></i> X√°c nh·∫≠n m·∫≠t kh·∫©u <span style="color: #EF4444;">*</span></label>
                            <input type="password" id="confirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required>
                        </div>

                        <div class="form-row">
                            <label for="fullName"><i class="fas fa-user"></i> T√™n ƒë·∫ßy ƒë·ªß <span style="color: #EF4444;">*</span></label>
                            <input type="text" id="fullName" placeholder="Nh·∫≠p t√™n ƒë·∫ßy ƒë·ªß" required>
                        </div>

                        <div class="form-row">
                            <label for="address"><i class="fas fa-map-marker-alt"></i> ƒê·ªãa ch·ªâ</label>
                            <input type="text" id="address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
                        </div>

                        <div class="form-row">
                            <label for="taxOffice"><i class="fas fa-building"></i> C∆° quan thu·∫ø</label>
                            <input type="text" id="taxOffice" placeholder="Nh·∫≠p c∆° quan thu·∫ø qu·∫£n l√Ω">
                        </div>

                        <div class="form-row">
                            <label for="phone"><i class="fas fa-phone"></i> S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="text" id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                        </div>

                        <div class="form-row">
                            <label for="email"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="email" placeholder="Nh·∫≠p email">
                        </div>
                    </div>

                    <h3 style="margin: 24px 0 16px 0; color: #4A90E2; font-size: 16px; font-weight: 600;"><i class="fas fa-coins"></i> Qu·∫£n l√Ω kho·∫£n thu·∫ø</h3>
                    
                    <!-- N√∫t th√™m kho·∫£n thu·∫ø -->
                    <div style="margin-bottom: 20px;">
                        <button type="button" class="btn btn-success" onclick="openTaxModal()" style="width: 100%;">
                            <i class="fas fa-plus"></i> Th√™m kho·∫£n thu·∫ø
                        </button>
                    </div>

                    <!-- Danh s√°ch kho·∫£n thu·∫ø ƒë√£ th√™m -->
                    <div id="taxItemsList" style="margin-bottom: 20px;">
                        <!-- C√°c kho·∫£n thu·∫ø s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                    </div>

                    <!-- Th√¥ng tin t·ªïng quan (t·ª± ƒë·ªông t√≠nh) -->
                    <div style="background: #F8FAFC; padding: 16px; border-radius: 8px; border: 1px solid #E2E8F0;">
                        <h4 style="margin-bottom: 12px; color: #4A90E2; font-size: 14px;"><i class="fas fa-calculator"></i> T·ªïng quan thu·∫ø (t·ª± ƒë·ªông t√≠nh)</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div>
                                <div style="font-size: 12px; color: #64748B;">T·ªïng ti·ªÅn thu·∫ø</div>
                                <div id="autoTotalAmount" style="font-weight: 600; color: #334155;">0 VND</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #64748B;">ƒê√£ n·ªôp</div>
                                <div id="autoPaidAmount" style="font-weight: 600; color: #16A34A;">0 VND</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #64748B;">C√≤n ph·∫£i n·ªôp</div>
                                <div id="autoPendingAmount" style="font-weight: 600; color: #DC2626;">0 VND</div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Th√™m ng∆∞·ªùi d√πng
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> L√†m m·ªõi
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- User List Tab -->
        <div id="userList" class="tab-content">
            <div class="form-section">
                <h2><i class="fas fa-list"></i> Danh s√°ch ng∆∞·ªùi d√πng MST</h2>
                <div id="userList" class="user-list">
                    <!-- Danh s√°ch s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>

        <!-- Certificate Manager Tab -->
        <div id="certificateManager" class="tab-content">
            <div class="certificate-section">
                <h2><i class="fas fa-file-pdf"></i> Qu·∫£n l√Ω ch·ª©ng t·ª´ PDF</h2>
                
                <div class="certificate-form">
                    <div class="certificate-form-row">
                        <label for="certMstSelect">Ch·ªçn MST</label>
                        <select id="certMstSelect" onchange="loadCertificatesForMst()">
                            <option value="">-- Ch·ªçn MST --</option>
                        </select>
                    </div>
                    
                    <div class="certificate-form-row">
                        <label>Upload file PDF ch·ª©ng t·ª´</label>
                        <div class="file-upload-area" onclick="document.getElementById('pdfFileInput').click()" 
                             ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">
                                Click ƒë·ªÉ ch·ªçn file ho·∫∑c k√©o th·∫£ file PDF v√†o ƒë√¢y
                            </div>
                        </div>
                        <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                </div>

                <div id="certificatePreview" class="certificate-preview" style="display: none;">
                    <h4>Th√¥ng tin tr√≠ch xu·∫•t t·ª´ PDF</h4>
                    <div class="certificate-info">
                        <div class="certificate-info-item">
                            <label>M√£ tham chi·∫øu</label>
                            <input type="text" id="extractedRefNumber" placeholder="M√£ tham chi·∫øu">
                        </div>
                        <div class="certificate-info-item">
                            <label>S·ªë ti·ªÅn</label>
                            <input type="text" id="extractedAmount" placeholder="S·ªë ti·ªÅn">
                        </div>
                        <div class="certificate-info-item">
                            <label>Ng√†y n·ªôp</label>
                            <input type="date" id="extractedPaymentDate">
                        </div>
                        <div class="certificate-info-item">
                            <label>Tr·∫°ng th√°i</label>
                            <input type="text" id="extractedStatus" placeholder="Tr·∫°ng th√°i">
                        </div>
                    </div>
                    <div class="certificate-actions">
                        <button class="btn-save-certificate" onclick="saveCertificate()">
                            <i class="fas fa-save"></i> L∆∞u ch·ª©ng t·ª´
                        </button>
                        <button class="btn-cancel-certificate" onclick="cancelCertificateUpload()">
                            <i class="fas fa-times"></i> H·ªßy
                        </button>
                    </div>
                </div>

                <div id="certificateList" class="certificate-list">
                    <!-- Danh s√°ch ch·ª©ng t·ª´ s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>

        <!-- Status Message -->
        <div id="statusMessage"></div>

        <!-- Modal qu·∫£n l√Ω kho·∫£n thu·∫ø -->
        <div id="taxModal" class="tax-modal">
            <div class="tax-modal-content">
                <div class="tax-modal-header">
                    <h3 id="taxModalTitle">Th√™m kho·∫£n thu·∫ø m·ªõi</h3>
                    <button onclick="closeTaxModal()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="tax-modal-tabs">
                    <div class="tax-modal-tab active" onclick="switchTaxTab('basic')">
                        <i class="fas fa-info-circle"></i> Th√¥ng tin c∆° b·∫£n
                    </div>
                    <div class="tax-modal-tab" onclick="switchTaxTab('detail')">
                        <i class="fas fa-file-alt"></i> Th√¥ng tin chi ti·∫øt
                    </div>
                </div>

                <div class="tax-modal-body">
                    <!-- Tab 1: Th√¥ng tin c∆° b·∫£n -->
                    <div id="taxTabBasic" class="tax-tab-content active">
                        <div class="tax-form-grid">
                            <div class="tax-form-row">
                                <label for="modalTaxOffice">T√™n c∆° quan thu</label>
                                <input type="text" id="modalTaxOffice" placeholder="VD: ƒê·ªôi Thu·∫ø th√†nh ph·ªë H·∫° Long">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxStatus">Lo·∫°i nghi·ªáp v·ª•</label>
                                <input type="text" id="taxStatus" placeholder="VD: C√≤n ph·∫£i n·ªôp">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxType">Ti√™u m·ª•c</label>
                                <textarea id="taxType" placeholder="VD: Thu·∫ø gi√° tr·ªã gia tƒÉng h√†ng s·∫£n xu·∫•t, kinh doanh trong n∆∞·ªõc (g·ªìm c·∫£ d·ªãch v·ª• trong lƒ©nh v·ª±c d·∫ßu kh√≠) (1701)" rows="3"></textarea>
                            </div>

                            <div class="tax-form-row">
                                <label for="taxAmount">S·ªë ti·ªÅn</label>
                                <input type="text" id="taxAmount" placeholder="VD: 2500000">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxSuggestion">G·ª£i √Ω x·ª≠ l√Ω</label>
                                <textarea id="taxSuggestion" placeholder="VD: N·ªôp thu·∫ø&#10;Tra so√°t" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Th√¥ng tin chi ti·∫øt -->
                    <div id="taxTabDetail" class="tax-tab-content">
                        <div class="tax-form-grid">
                            <div class="tax-form-row">
                                <label for="taxId">ID kho·∫£n ph·∫£i n·ªôp</label>
                                <input type="text" id="taxId" placeholder="VD: 04057866369400001">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxDecision">S·ªë quy·∫øt ƒë·ªãnh/S·ªë th√¥ng b√°o</label>
                                <input type="text" id="taxDecision" placeholder="VD: 1866/TB-CCT">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxDate">Ng√†y quy·∫øt ƒë·ªãnh/Ng√†y th√¥ng b√°o</label>
                                <input type="text" id="taxDate" placeholder="VD: 07/01/2025">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxChapter">Ch∆∞∆°ng</label>
                                <input type="text" id="taxChapter" placeholder="VD: 757">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxPeriod">K·ª≥ thu·∫ø</label>
                                <input type="text" id="taxPeriod" placeholder="VD: 00/06/2025">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxRegion">ƒê·ªãa b√†n h√†nh ch√≠nh</label>
                                <input type="text" id="taxRegion" placeholder="VD: Th√†nh ph·ªë H·∫° Long (193HH)">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxDueDate">H·∫°n n·ªôp</label>
                                <input type="text" id="taxDueDate" placeholder="VD: 30/06/2025">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxPaid">S·ªë ti·ªÅn ƒë√£ n·ªôp</label>
                                <input type="text" id="taxPaid" placeholder="VD: 0">
                            </div>

                            <div class="tax-form-row">
                                <label for="taxReference">S·ªë tham chi·∫øu</label>
                                <input type="text" id="taxReference" placeholder="VD: 11020250031907891">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tax-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaxModal()">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button type="button" class="btn" onclick="saveTaxItem()">
                        <i class="fas fa-save"></i> L∆∞u kho·∫£n thu·∫ø
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentTaxItems = []; // M·∫£ng l∆∞u c√°c kho·∫£n thu·∫ø hi·ªán t·∫°i
        let editingTaxIndex = -1; // Index c·ªßa kho·∫£n thu·∫ø ƒëang s·ª≠a (-1 = th√™m m·ªõi)

        // Tab System Functions
        function showTab(tabName) {
            // ·∫®n t·∫•t c·∫£ tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(tabName).classList.add('active');
            
            // Update active button
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set active button - fix event.target issue
            const activeButton = document.querySelector(`[onclick*="showTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Load data if needed
            if (tabName === 'userList') {
                loadUserList();
            } else if (tabName === 'dashboard') {
                refreshStats();
            }
        }

        // Logout function
        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('admin_logged_in');
                localStorage.removeItem('admin_login_time');
                window.location.href = 'admin-login.html';
            }
        }

        // Kh·ªüi t·∫°o khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserList();
            refreshStats();
        });

        // Th√™m ng∆∞·ªùi d√πng m·ªõi
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const mst = document.getElementById('mst')?.value?.trim() || '';
            const password = document.getElementById('password')?.value?.trim() || '';
            const confirmPassword = document.getElementById('confirmPassword')?.value?.trim() || '';
            const fullName = document.getElementById('fullName')?.value?.trim() || '';
            const address = document.getElementById('address')?.value?.trim() || '';
            const taxOffice = document.getElementById('taxOffice')?.value?.trim() || '';
            const phone = document.getElementById('phone')?.value?.trim() || '';
            const email = document.getElementById('email')?.value?.trim() || '';

            // Validation
            if (!mst || !password || !fullName) {
                showStatus('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (MST, M·∫≠t kh·∫©u v√† T√™n)!', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showStatus('M·∫≠t kh·∫©u v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp!', 'error');
                return;
            }

            if (password.length < 6) {
                showStatus('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
                return;
            }

            // Ki·ªÉm tra MST ƒë√£ t·ªìn t·∫°i ch∆∞a
            if (localStorage.getItem(`etax_user_data_${mst}`)) {
                showStatus(`MST ${mst} ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!`, 'error');
                return;
            }

            // T√≠nh to√°n t·ªïng quan thu·∫ø t·ª´ c√°c kho·∫£n thu·∫ø
            const totalAmount = calculateTotalAmount();
            const paidAmount = calculatePaidAmount();
            const pendingAmount = totalAmount - paidAmount;

            // T·∫°o d·ªØ li·ªáu ng∆∞·ªùi d√πng m·ªõi
            const newUserData = {
                mst: mst,
                password: password,
                fullName: fullName.toUpperCase(),
                address: address,
                taxOffice: taxOffice,
                phone: phone,
                email: email,
                taxInfo: {
                    totalAmount: formatCurrency(totalAmount),
                    paidAmount: formatCurrency(paidAmount),
                    pendingAmount: formatCurrency(pendingAmount),
                    items: [...currentTaxItems] // Copy m·∫£ng kho·∫£n thu·∫ø hi·ªán t·∫°i
                }
            };

            // L∆∞u v√†o localStorage
            localStorage.setItem(`etax_user_data_${mst}`, JSON.stringify(newUserData));

            showStatus(`‚úÖ ƒê√£ th√™m ng∆∞·ªùi d√πng ${fullName} v·ªõi MST ${mst} v√† ${currentTaxItems.length} kho·∫£n thu·∫ø`, 'success');

            // Reset form v√† d·ªØ li·ªáu
            document.getElementById('addUserForm').reset();
            currentTaxItems = [];
            editingTaxIndex = -1;
            renderTaxItemsList();
            updateTaxSummary();
            loadUserList();
            refreshStats();
            
            // Chuy·ªÉn v·ªÅ tab danh s√°ch ƒë·ªÉ xem k·∫øt qu·∫£
            setTimeout(() => {
                showTab('userList');
            }, 1000);
        });

        // T·∫£i danh s√°ch ng∆∞·ªùi d√πng
        function loadUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            // Duy·ªát qua localStorage ƒë·ªÉ t√¨m d·ªØ li·ªáu ng∆∞·ªùi d√πng
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('etax_user_data_')) {
                    const mst = key.replace('etax_user_data_', '');
                    const userData = JSON.parse(localStorage.getItem(key));

                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    userCard.innerHTML = `
                        <div class="user-header">
                            <i class="fas fa-user"></i> ${userData.fullName} (MST: ${userData.mst})
                        </div>

                        <div class="user-info">
                            <div class="info-item">
                                <div class="info-label">ƒê·ªãa ch·ªâ</div>
                                <div class="info-value">${userData.address || 'Ch∆∞a c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">C∆° quan thu·∫ø</div>
                                <div class="info-value">${userData.taxOffice || 'Ch∆∞a c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ƒêi·ªán tho·∫°i</div>
                                <div class="info-value">${userData.phone || 'Ch∆∞a c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Email</div>
                                <div class="info-value">${userData.email || 'Ch∆∞a c·∫≠p nh·∫≠t'}</div>
                            </div>
                        </div>

                        <div class="tax-summary">
                            <strong>üí∞ Th√¥ng tin thu·∫ø:</strong><br>
                            T·ªïng: ${userData.taxInfo?.totalAmount || '0 VND'} |
                            ƒê√£ n·ªôp: ${userData.taxInfo?.paidAmount || '0 VND'} |
                            C√≤n ph·∫£i n·ªôp: ${userData.taxInfo?.pendingAmount || '0 VND'}<br>
                            <strong>üìã S·ªë kho·∫£n thu·∫ø:</strong> ${userData.taxInfo?.items?.length || 0} kho·∫£n
                        </div>

                        <div class="button-group">
                            <button class="btn" onclick="editUser('${mst}')">
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                            <button class="btn btn-danger" onclick="deleteUser('${mst}')">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                            <button class="btn btn-success" onclick="testLogin('${mst}')">
                                <i class="fas fa-sign-in-alt"></i> Test ƒêƒÉng nh·∫≠p
                            </button>
                        </div>
                    `;

                    userList.appendChild(userCard);
                }
            }

            if (userList.children.length === 0) {
                userList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o. H√£y th√™m ng∆∞·ªùi d√πng MST m·ªõi!</p>';
            }
        }

        // S·ª≠a th√¥ng tin ng∆∞·ªùi d√πng
        function editUser(mst) {
            const userData = JSON.parse(localStorage.getItem(`etax_user_data_${mst}`));

            document.getElementById('mst').value = userData.mst;
            document.getElementById('fullName').value = userData.fullName;
            document.getElementById('address').value = userData.address || '';
            document.getElementById('taxOffice').value = userData.taxOffice || '';
            document.getElementById('phone').value = userData.phone || '';
            document.getElementById('email').value = userData.email || '';

            // Parse s·ªë ti·ªÅn t·ª´ format VND
            const totalAmount = parseCurrency(userData.taxInfo?.totalAmount || '0 VND');
            const paidAmount = parseCurrency(userData.taxInfo?.paidAmount || '0 VND');
            const pendingAmount = parseCurrency(userData.taxInfo?.pendingAmount || '0 VND');

            document.getElementById('totalAmount').value = totalAmount;
            document.getElementById('paidAmount').value = paidAmount;
            document.getElementById('pendingAmount').value = pendingAmount;

            // Chuy·ªÉn v·ªÅ tab th√™m MST
            showTab('addUser');
        }

        // X√≥a ng∆∞·ªùi d√πng
        function deleteUser(mst) {
            if (confirm(`‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng v·ªõi MST: ${mst}?\n\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan!`)) {
                localStorage.removeItem(`etax_user_data_${mst}`);
                showStatus(`üóëÔ∏è ƒê√£ x√≥a ng∆∞·ªùi d√πng v·ªõi MST: ${mst}`, 'success');
                loadUserList();
                refreshStats();
            }
        }

        // Test ƒëƒÉng nh·∫≠p v·ªõi MST
        function testLogin(mst) {
            // L·∫•y d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß c·ªßa user
            const userData = JSON.parse(localStorage.getItem(`etax_user_data_${mst}`));
            if (!userData) {
                showStatus(`‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho MST: ${mst}`, 'error');
                return;
            }

            // L∆∞u MST v√†o session ƒë·ªÉ test
            localStorage.setItem('etax_logged_in_user', mst);
            
            // L∆∞u th√¥ng tin c∆° b·∫£n c·ªßa user
            localStorage.setItem('etax_user_info', JSON.stringify({
                mst: userData.mst,
                fullName: userData.fullName,
                address: userData.address,
                taxOffice: userData.taxOffice,
                phone: userData.phone,
                email: userData.email
            }));
            
            // L∆∞u d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß c·ªßa user (bao g·ªìm taxInfo)
            localStorage.setItem('etax_user_data', JSON.stringify(userData));
            
            showStatus(`üîë ƒê√£ ƒëƒÉng nh·∫≠p v·ªõi MST: ${mst}. M·ªü trang ch·ªß ƒë·ªÉ ki·ªÉm tra ƒë·ªìng b·ªô d·ªØ li·ªáu!`, 'success');

            // M·ªü trang ch·ªß trong tab m·ªõi
            window.open('src/pages/index.html', '_blank');
        }

        // L√†m m·ªõi th·ªëng k√™
        function refreshStats() {
            let totalUsers = 0;
            let totalTaxAmount = 0;
            let totalPendingAmount = 0;

            // Duy·ªát qua localStorage ƒë·ªÉ t√≠nh th·ªëng k√™
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('etax_user_data_')) {
                    totalUsers++;
                    const userData = JSON.parse(localStorage.getItem(key));
                    if (userData.taxInfo) {
                        totalTaxAmount += parseCurrency(userData.taxInfo.totalAmount || '0 VND');
                        totalPendingAmount += parseCurrency(userData.taxInfo.pendingAmount || '0 VND');
                    }
                }
            }

            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalTaxAmount').textContent = formatCurrency(totalTaxAmount);
            document.getElementById('pendingAmount').textContent = formatCurrency(totalPendingAmount);

            showStatus(`üìä ƒê√£ c·∫≠p nh·∫≠t th·ªëng k√™: ${totalUsers} MST, T·ªïng thu·∫ø: ${formatCurrency(totalTaxAmount)}`, 'info');
        }

        // Xu·∫•t d·ªØ li·ªáu
        function exportData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('etax_user_data_')) {
                    data[key] = JSON.parse(localStorage.getItem(key));
                }
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'etax-mst-data-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);

            showStatus('üì• ƒê√£ xu·∫•t d·ªØ li·ªáu MST th√†nh c√¥ng!', 'success');
        }

        // X√≥a t·∫•t c·∫£ d·ªØ li·ªáu
        function clearAllData() {
            if (confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu MST?\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!')) {
                const keysToDelete = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('etax_user_data_')) {
                        keysToDelete.push(key);
                    }
                }

                keysToDelete.forEach(key => localStorage.removeItem(key));

                showStatus(`üóëÔ∏è ƒê√£ x√≥a ${keysToDelete.length} b·∫£n ghi MST`, 'success');
                loadUserList();
                refreshStats();
            }
        }


        // Utility functions
        function formatCurrency(amount) {
            return parseInt(amount).toLocaleString('vi-VN') + ' VND';
        }

        function parseCurrency(amountStr) {
            return parseInt(amountStr.replace(/[^\d]/g, '')) || 0;
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o tr·∫°ng th√°i
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            statusElement.className = `status ${type}`;

            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                statusElement.innerHTML = '';
                statusElement.className = 'status';
            }, 5000);
        }

        // ===== TAX MODAL FUNCTIONS =====
        
        // M·ªü modal th√™m/s·ª≠a kho·∫£n thu·∫ø
        function openTaxModal() {
            editingTaxIndex = -1;
            document.getElementById('taxModalTitle').textContent = 'Th√™m kho·∫£n thu·∫ø m·ªõi';
            clearTaxModalForm();
            document.getElementById('taxModal').style.display = 'flex';
            switchTaxTab('basic');
        }

        // ƒê√≥ng modal
        function closeTaxModal() {
            document.getElementById('taxModal').style.display = 'none';
            clearTaxModalForm();
            editingTaxIndex = -1;
        }

        // Chuy·ªÉn tab trong modal
        function switchTaxTab(tabName) {
            // ·∫®n t·∫•t c·∫£ tab content
            document.querySelectorAll('.tax-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ·∫®n t·∫•t c·∫£ tab buttons
            document.querySelectorAll('.tax-modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(`taxTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            document.querySelector(`[onclick="switchTaxTab('${tabName}')"]`).classList.add('active');
        }

        // L√†m s·∫°ch form modal
        function clearTaxModalForm() {
            const fields = [
                'modalTaxOffice', 'taxStatus', 'taxType', 'taxAmount', 'taxSuggestion',
                'taxId', 'taxDecision', 'taxDate', 'taxChapter', 'taxPeriod',
                'taxRegion', 'taxDueDate', 'taxPaid', 'taxReference'
            ];
            
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = '';
                }
            });
        }

        // L∆∞u kho·∫£n thu·∫ø
        function saveTaxItem() {
            // L·∫•y d·ªØ li·ªáu t·ª´ form
            const taxData = {
                office: document.getElementById('modalTaxOffice').value.trim(),
                status: document.getElementById('taxStatus').value.trim(),
                type: document.getElementById('taxType').value.trim(),
                amount: document.getElementById('taxAmount').value.trim(),
                suggestion: document.getElementById('taxSuggestion').value.trim(),
                detail: {
                    id: document.getElementById('taxId').value.trim(),
                    decision: document.getElementById('taxDecision').value.trim(),
                    date: document.getElementById('taxDate').value.trim(),
                    chapter: document.getElementById('taxChapter').value.trim(),
                    period: document.getElementById('taxPeriod').value.trim(),
                    region: document.getElementById('taxRegion').value.trim(),
                    dueDate: document.getElementById('taxDueDate').value.trim(),
                    paid: document.getElementById('taxPaid').value.trim(),
                    reference: document.getElementById('taxReference').value.trim()
                }
            };

            // Validation
            if (!taxData.office || !taxData.status || !taxData.type || !taxData.amount) {
                showStatus('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin c∆° b·∫£n c·ªßa kho·∫£n thu·∫ø!', 'error');
                return;
            }

            // Format s·ªë ti·ªÅn
            const amount = parseInt(taxData.amount) || 0;
            taxData.amount = formatCurrency(amount);
            
            const paidAmount = parseInt(taxData.detail.paid) || 0;
            taxData.detail.paid = formatCurrency(paidAmount);

            // Th√™m ho·∫∑c c·∫≠p nh·∫≠t v√†o m·∫£ng
            if (editingTaxIndex >= 0) {
                currentTaxItems[editingTaxIndex] = taxData;
                showStatus('‚úÖ ƒê√£ c·∫≠p nh·∫≠t kho·∫£n thu·∫ø', 'success');
            } else {
                currentTaxItems.push(taxData);
                showStatus('‚úÖ ƒê√£ th√™m kho·∫£n thu·∫ø m·ªõi', 'success');
            }

            // C·∫≠p nh·∫≠t UI
            renderTaxItemsList();
            updateTaxSummary();
            closeTaxModal();
        }

        // Render danh s√°ch kho·∫£n thu·∫ø
        function renderTaxItemsList() {
            const container = document.getElementById('taxItemsList');
            
            if (currentTaxItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px; font-style: italic;">Ch∆∞a c√≥ kho·∫£n thu·∫ø n√†o. H√£y th√™m kho·∫£n thu·∫ø ƒë·∫ßu ti√™n!</p>';
                return;
            }

            container.innerHTML = currentTaxItems.map((item, index) => `
                <div class="tax-item-card">
                    <div class="tax-item-header">
                        <div class="tax-item-title">${item.office || 'Ch∆∞a c√≥ t√™n c∆° quan'}</div>
                        <div class="tax-item-actions">
                            <button class="tax-item-btn edit" onclick="editTaxItem(${index})">
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                            <button class="tax-item-btn delete" onclick="deleteTaxItem(${index})">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                        </div>
                    </div>
                    <div class="tax-item-info">
                        <div class="tax-item-field">
                            <div class="tax-item-label">Lo·∫°i nghi·ªáp v·ª•</div>
                            <div class="tax-item-value">${item.status || 'N/A'}</div>
                        </div>
                        <div class="tax-item-field">
                            <div class="tax-item-label">S·ªë ti·ªÅn</div>
                            <div class="tax-item-value tax-item-amount">${item.amount || '0 VND'}</div>
                        </div>
                        <div class="tax-item-field">
                            <div class="tax-item-label">Ti√™u m·ª•c</div>
                            <div class="tax-item-value">${item.type ? item.type.substring(0, 50) + (item.type.length > 50 ? '...' : '') : 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // S·ª≠a kho·∫£n thu·∫ø
        function editTaxItem(index) {
            editingTaxIndex = index;
            const item = currentTaxItems[index];
            
            document.getElementById('taxModalTitle').textContent = 'S·ª≠a kho·∫£n thu·∫ø';
            
            // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
            document.getElementById('modalTaxOffice').value = item.office || '';
            document.getElementById('taxStatus').value = item.status || '';
            document.getElementById('taxType').value = item.type || '';
            document.getElementById('taxAmount').value = parseCurrency(item.amount || '0 VND');
            document.getElementById('taxSuggestion').value = item.suggestion || '';
            
            if (item.detail) {
                document.getElementById('taxId').value = item.detail.id || '';
                document.getElementById('taxDecision').value = item.detail.decision || '';
                document.getElementById('taxDate').value = item.detail.date || '';
                document.getElementById('taxChapter').value = item.detail.chapter || '';
                document.getElementById('taxPeriod').value = item.detail.period || '';
                document.getElementById('taxRegion').value = item.detail.region || '';
                document.getElementById('taxDueDate').value = item.detail.dueDate || '';
                document.getElementById('taxPaid').value = parseCurrency(item.detail.paid || '0 VND');
                document.getElementById('taxReference').value = item.detail.reference || '';
            }
            
            document.getElementById('taxModal').style.display = 'flex';
            switchTaxTab('basic');
        }

        // X√≥a kho·∫£n thu·∫ø
        function deleteTaxItem(index) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho·∫£n thu·∫ø n√†y?')) {
                currentTaxItems.splice(index, 1);
                renderTaxItemsList();
                updateTaxSummary();
                showStatus('üóëÔ∏è ƒê√£ x√≥a kho·∫£n thu·∫ø', 'success');
            }
        }

        // T√≠nh t·ªïng ti·ªÅn thu·∫ø
        function calculateTotalAmount() {
            return currentTaxItems.reduce((total, item) => {
                return total + parseCurrency(item.amount || '0 VND');
            }, 0);
        }

        // T√≠nh t·ªïng ƒë√£ n·ªôp
        function calculatePaidAmount() {
            return currentTaxItems.reduce((total, item) => {
                return total + parseCurrency(item.detail?.paid || '0 VND');
            }, 0);
        }

        // C·∫≠p nh·∫≠t t·ªïng quan thu·∫ø
        function updateTaxSummary() {
            const totalAmount = calculateTotalAmount();
            const paidAmount = calculatePaidAmount();
            const pendingAmount = totalAmount - paidAmount;

            document.getElementById('autoTotalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('autoPaidAmount').textContent = formatCurrency(paidAmount);
            document.getElementById('autoPendingAmount').textContent = formatCurrency(pendingAmount);
        }

        // C·∫≠p nh·∫≠t function editUser ƒë·ªÉ load kho·∫£n thu·∫ø
        function editUser(mst) {
            const userData = JSON.parse(localStorage.getItem(`etax_user_data_${mst}`));

            document.getElementById('mst').value = userData.mst;
            document.getElementById('password').value = userData.password || '';
            document.getElementById('confirmPassword').value = userData.password || '';
            document.getElementById('fullName').value = userData.fullName;
            document.getElementById('address').value = userData.address || '';
            document.getElementById('taxOffice').value = userData.taxOffice || '';
            document.getElementById('phone').value = userData.phone || '';
            document.getElementById('email').value = userData.email || '';

            // Load kho·∫£n thu·∫ø
            currentTaxItems = userData.taxInfo?.items || [];
            renderTaxItemsList();
            updateTaxSummary();

            // Chuy·ªÉn v·ªÅ tab th√™m MST
            showTab('addUser');
        }

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
            authDomain: "etax-7fbf8.firebaseapp.com",
            databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "etax-7fbf8",
            storageBucket: "etax-7fbf8.appspot.com",
            messagingSenderId: "1030026724634",
            appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
            measurementId: "G-YS5DLECJE6"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.log('Firebase already initialized');
        }

        const storage = firebase.storage ? firebase.storage() : null;

        // Certificate Management Functions
        let currentCertificateFile = null;
        let extractedCertificateData = null;

        // Load MST list for certificate management
        function loadMstListForCertificates() {
            const mstSelect = document.getElementById('certMstSelect');
            mstSelect.innerHTML = '<option value="">-- Ch·ªçn MST --</option>';
            
            // Load all MSTs from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('etax_user_data_')) {
                    const mst = key.replace('etax_user_data_', '');
                    const userData = JSON.parse(localStorage.getItem(key));
                    const option = document.createElement('option');
                    option.value = mst;
                    option.textContent = `${mst} - ${userData.fullName}`;
                    mstSelect.appendChild(option);
                }
            }
        }

        // Load certificates for selected MST
        function loadCertificatesForMst() {
            const mst = document.getElementById('certMstSelect').value;
            const certificateList = document.getElementById('certificateList');
            
            if (!mst) {
                certificateList.innerHTML = '';
                return;
            }

            const certificates = JSON.parse(localStorage.getItem(`etax_certificates_${mst}`)) || [];
            
            if (certificates.length === 0) {
                certificateList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ ch·ª©ng t·ª´ n√†o cho MST n√†y</p>';
                return;
            }

            certificateList.innerHTML = certificates.map(cert => `
                <div class="certificate-item">
                    <div class="certificate-item-info">
                        <div class="certificate-item-title">${cert.referenceNumber || 'Ch∆∞a c√≥ m√£ tham chi·∫øu'}</div>
                        <div class="certificate-item-details">
                            S·ªë ti·ªÅn: ${formatCurrency(cert.amount)} | 
                            Ng√†y: ${formatDate(cert.paymentDate)} | 
                            Tr·∫°ng th√°i: ${cert.status}<br>
                            <small style="color: #666;">File: ${cert.fileName || 'N/A'} (${formatFileSize(cert.fileSize || 0)})</small>
                        </div>
                    </div>
                    <div class="certificate-item-actions">
                        <button class="btn btn-success" onclick="downloadCertificate('${cert.id}', '${mst}')" style="margin-right: 8px;">
                            <i class="fas fa-download"></i> T·∫£i
                        </button>
                        <button class="btn-delete-certificate" onclick="deleteCertificate('${cert.id}', '${mst}')">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Security validation
            if (!validateFileSecurity(file)) {
                return;
            }
            
            if (file.type === 'application/pdf') {
                currentCertificateFile = file;
                extractPDFInfo(file);
            } else {
                showStatus('‚ùå Vui l√≤ng ch·ªçn file PDF h·ª£p l·ªá', 'error');
            }
        }

        // Enhanced file security validation
        function validateFileSecurity(file) {
            // Check file size (max 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showStatus('‚ùå File qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa: 10MB', 'error');
                return false;
            }
            
            // Check file type
            if (file.type !== 'application/pdf') {
                showStatus('‚ùå Ch·ªâ ch·∫•p nh·∫≠n file PDF', 'error');
                return false;
            }
            
            // Check file name for suspicious patterns
            const suspiciousPatterns = /\.(exe|bat|cmd|scr|pif|com)$/i;
            if (suspiciousPatterns.test(file.name)) {
                showStatus('‚ùå T√™n file kh√¥ng h·ª£p l·ªá', 'error');
                return false;
            }
            
            // Check for malicious content patterns
            if (file.name.includes('..') || file.name.includes('/') || file.name.includes('\\')) {
                showStatus('‚ùå T√™n file ch·ª©a k√Ω t·ª± kh√¥ng h·ª£p l·ªá', 'error');
                return false;
            }
            
            return true;
        }

        // Handle drag and drop
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                
                // Security validation
                if (!validateFileSecurity(file)) {
                    return;
                }
                
                if (file.type === 'application/pdf') {
                    currentCertificateFile = file;
                    extractPDFInfo(file);
                } else {
                    showStatus('‚ùå Vui l√≤ng ch·ªçn file PDF h·ª£p l·ªá', 'error');
                }
            }
        }

        // Extract PDF information using PDF.js
        async function extractPDFInfo(file) {
            try {
                showStatus('üìÑ ƒêang tr√≠ch xu·∫•t th√¥ng tin t·ª´ PDF...', 'info');
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = '';
                
                // Extract text from all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + ' ';
                }

                // Extract information using regex patterns
                const extractedData = extractCertificateData(fullText);
                
                // Show preview
                document.getElementById('extractedRefNumber').value = extractedData.referenceNumber;
                document.getElementById('extractedAmount').value = extractedData.amount;
                document.getElementById('extractedPaymentDate').value = extractedData.paymentDate;
                document.getElementById('extractedStatus').value = extractedData.status;
                
                document.getElementById('certificatePreview').style.display = 'block';
                extractedCertificateData = extractedData;
                
                showStatus('‚úÖ Tr√≠ch xu·∫•t th√¥ng tin th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra v√† ch·ªânh s·ª≠a n·∫øu c·∫ßn', 'success');
                
            } catch (error) {
                console.error('Error extracting PDF:', error);
                showStatus('‚ùå L·ªói khi tr√≠ch xu·∫•t th√¥ng tin t·ª´ PDF', 'error');
            }
        }

        // Extract certificate data from text
        function extractCertificateData(text) {
            // Regex patterns for Vietnamese tax certificates
            const refPattern = /(\d{6}\s*\d{6}\s*\d{5})|(\d{6})/g;
            const amountPattern = /(\d{1,3}(?:[,\.]\d{3})*(?:[,\.]\d{2})?)\s*(?:VND|ƒë|vnƒë)?/g;
            const datePattern = /(\d{2}[/-]\d{2}[/-]\d{4})/g;
            
            const referenceNumber = refPattern.exec(text)?.[0] || '';
            const amount = amountPattern.exec(text)?.[0] || '';
            const dateMatch = datePattern.exec(text)?.[0] || '';
            
            // Convert date format
            let paymentDate = '';
            if (dateMatch) {
                const parts = dateMatch.split(/[/-]/);
                if (parts.length === 3) {
                    paymentDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                }
            }
            
            // Determine status based on keywords
            let status = 'Th√†nh c√¥ng';
            if (text.includes('th√†nh c√¥ng') || text.includes('ho√†n th√†nh')) {
                status = 'Th√†nh c√¥ng ‚Äì NH/TGTT ƒë√£ tr·ª´ ti·ªÅn th√†nh c√¥ng';
            } else if (text.includes('ch·ªù') || text.includes('pending')) {
                status = 'ƒêang ch·ªù x·ª≠ l√Ω';
            }

            return {
                referenceNumber: referenceNumber,
                amount: amount.replace(/[^\d]/g, ''), // Remove non-digits
                paymentDate: paymentDate,
                status: status
            };
        }

        // Save certificate - Using LocalStorage instead of Firebase
        async function saveCertificate() {
            const mst = document.getElementById('certMstSelect').value;
            if (!mst) {
                showStatus('‚ùå Vui l√≤ng ch·ªçn MST', 'error');
                return;
            }

            if (!currentCertificateFile) {
                showStatus('‚ùå Vui l√≤ng ch·ªçn file PDF', 'error');
                return;
            }

            try {
                showStatus('üì§ ƒêang l∆∞u file PDF...', 'info');

                // Convert file to base64 for localStorage storage
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // Create certificate object with base64 data
                        const certificate = {
                            id: `cert_${Date.now()}`,
                            referenceNumber: document.getElementById('extractedRefNumber').value,
                            amount: document.getElementById('extractedAmount').value,
                            paymentDate: document.getElementById('extractedPaymentDate').value,
                            status: document.getElementById('extractedStatus').value,
                            fileName: currentCertificateFile.name,
                            fileSize: currentCertificateFile.size,
                            fileData: e.target.result, // Base64 data
                            uploadDate: new Date().toISOString()
                        };

                        // Save to localStorage
                        const certificates = JSON.parse(localStorage.getItem(`etax_certificates_${mst}`)) || [];
                        certificates.push(certificate);
                        localStorage.setItem(`etax_certificates_${mst}`, JSON.stringify(certificates));

                        // Reset form
                        cancelCertificateUpload();
                        loadCertificatesForMst();
                        
                        showStatus('‚úÖ L∆∞u ch·ª©ng t·ª´ th√†nh c√¥ng!', 'success');
                        
                    } catch (error) {
                        console.error('Error saving certificate:', error);
                        showStatus('‚ùå L·ªói khi l∆∞u ch·ª©ng t·ª´', 'error');
                    }
                };
                
                reader.onerror = function() {
                    showStatus('‚ùå L·ªói ƒë·ªçc file PDF', 'error');
                };
                
                reader.readAsDataURL(currentCertificateFile);

            } catch (error) {
                console.error('Error saving certificate:', error);
                showStatus('‚ùå L·ªói khi l∆∞u ch·ª©ng t·ª´', 'error');
            }
        }

        // Cancel certificate upload
        function cancelCertificateUpload() {
            currentCertificateFile = null;
            extractedCertificateData = null;
            document.getElementById('pdfFileInput').value = '';
            document.getElementById('certificatePreview').style.display = 'none';
            document.getElementById('extractedRefNumber').value = '';
            document.getElementById('extractedAmount').value = '';
            document.getElementById('extractedPaymentDate').value = '';
            document.getElementById('extractedStatus').value = '';
        }

        // Delete certificate - Using LocalStorage
        async function deleteCertificate(certId, mst) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ª©ng t·ª´ n√†y?')) {
                return;
            }

            try {
                const certificates = JSON.parse(localStorage.getItem(`etax_certificates_${mst}`)) || [];
                const certIndex = certificates.findIndex(c => c.id === certId);
                
                if (certIndex !== -1) {
                    // Remove from localStorage
                    certificates.splice(certIndex, 1);
                    localStorage.setItem(`etax_certificates_${mst}`, JSON.stringify(certificates));
                    
                    loadCertificatesForMst();
                    showStatus('‚úÖ X√≥a ch·ª©ng t·ª´ th√†nh c√¥ng!', 'success');
                }
            } catch (error) {
                console.error('Error deleting certificate:', error);
                showStatus('‚ùå L·ªói khi x√≥a ch·ª©ng t·ª´', 'error');
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            const num = parseInt(amount) || 0;
            return num.toLocaleString('vi-VN') + ' VND';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Download certificate file
        function downloadCertificate(certId, mst) {
            try {
                const certificates = JSON.parse(localStorage.getItem(`etax_certificates_${mst}`)) || [];
                const cert = certificates.find(c => c.id === certId);
                
                if (!cert || !cert.fileData) {
                    showStatus('‚ùå Kh√¥ng t√¨m th·∫•y file ch·ª©ng t·ª´', 'error');
                    return;
                }

                // Create download link
                const link = document.createElement('a');
                link.href = cert.fileData;
                link.download = cert.fileName || `certificate_${certId}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('‚úÖ ƒê√£ t·∫£i file ch·ª©ng t·ª´', 'success');
            } catch (error) {
                console.error('Error downloading certificate:', error);
                showStatus('‚ùå L·ªói khi t·∫£i file', 'error');
            }
        }

        // Initialize certificate management when tab is shown
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button - Fix event.target issue
            const activeButton = document.querySelector(`[onclick*="showTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Load data for specific tabs
            if (tabName === 'certificateManager') {
                loadMstListForCertificates();
            } else if (tabName === 'userList') {
                loadUserList();
            } else if (tabName === 'dashboard') {
                refreshStats(); // Use existing function instead of loadDashboard
            }
        }
    </script>
</body>
</html>
